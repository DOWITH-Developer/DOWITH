{% extends 'layout.html' %}

{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'login/css/mycalendar.css' %}">
    <link rel="stylesheet" href="{% static 'login/css/mypage.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="{% static 'friend/javascript/friend_list.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="mypage">
        <div class="calendar_container">
            <div class="calendar_header">
                <h2 class="calendar_title"></h2>
                <button class="previous">previous</button>
                <button class="after">after</button>
            </div>
            <div class="weekday">
                <div>ì¼ìš”ì¼</div>
                <div>ì›”ìš”ì¼</div>
                <div>í™”ìš”ì¼</div>
                <div>ìˆ˜ìš”ì¼</div>
                <div>ëª©ìš”ì¼</div>
                <div>ê¸ˆìš”ì¼</div>
                <div>í† ìš”ì¼</div>
            </div>
            <div class="calendar"></div>
        </div>
        <div class="challenge_list">
            <h3>ì˜¤ëŠ˜ì˜ ì±Œë¦°ì§€ ë¦¬ìŠ¤íŠ¸</h3>
            {% for end in enrollmentdates %}
                <div class="one_challenge">
                    <div class="challenge_title"><a href="{% url 'challenge:challenge_detail' end.enrollment.challenge.id%}">{{end.enrollment.challenge.title}}</a></div>
                    <div class="result result-{{end.id}}" onclick="onClickResult({{end.pk}})">
                        {% if end.date_result %}
                            <input type="button" class="result_word success" value="ì±Œë¦°ì§€ ì„±ê³µ"></input>
                        {% elif end.date_result == False %}
                            <input type="button" class="result_word fail" value="ì„±ê³µì‹œ í´ë¦­"></input>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <br>

        <div class="friend__list">
                <h3> ì˜¤ëŠ˜ ë‚´ ì¹œêµ¬ë“¤ì€?</h3>
                <div class="friends">
                    {% for fd in friends %}
                    <div class="friend_total">
                        <div class="one_friend">
                            <div>
                                <a href="{% url 'friend:fd_detail' fd.me.pk %}">
                                    <img class="friends__profile__image" src="{% static 'img/DOWITH.png' %}" alt="logo">
                                    <p class="friends__profile__name">{{fd.me}}</p>
                                </a>
                            </div>
                            <div class="complete_challenge">
                                <div>ì˜¤ëŠ˜ ì™„ë£Œí•œ ì±Œë¦°ì§€</div>
                                <div><span class="green_text">{{friends_enrollment|get_item:fd.me.id}}</span>ê°œ</div>
                            </div>
                        </div>
                        <div>
                            <button class="one_friend_motivate" onclick="giveMotivation({{fd.me.id}})">ì‘ì›í•˜ê¸°</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
        </div>

        <br>
        <a href="{% url 'friend:fd_list' %}">ì¹œêµ¬ ë”ë³´ê¸°</a><br>
        <br>

                <!--ì„ì‹œë°©í¸ìœ¼ë¡œ ìœ„ì¹˜ë§Œ ì¡ì•„ë‘” ê²ƒ ë‚˜ì¤‘ì— ì½”ë“œ ë³µì‚¬ë¥¼ í†µí•´ì„œ ìœ„ì¹˜ ì¡°ì • ì˜ˆì •-->
        <div class="friend__motivation">
            <h3>ë‚˜ë¥¼ ì°Œë¥¸ ì¹œêµ¬</h3>
            <button onclick="removeMotivation()">ëª¨ë‘ ì§€ìš°ê¸°</button>
            {% for motivation in motivation_from_friends %}

                <li class="friend__motivation__from__friend motivation-{{motivation.id}}">{{motivation.me.nickname}}ë‹˜ì´ {{motivation.count}}ë²ˆ ì½• ì°”ë €ìŠµë‹ˆë‹¤. <button onclick="removeMotivation({{motivation.id}})">ì§€ìš°ê¸°</button></li>

            {% endfor %}
        </div>

        <a href="{% url 'login:settings' %}">ì„¤ì •ìœ¼ë¡œ ê°€ê¸°</a>
        <br>
    </div>
    <script>

//! Calendar
let months = ["0ì›”", "1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", 
"7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];

const calendarTitle = document.querySelector('.calendar_title')
const today = new Date();

//ë‚ ì§œ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ëŠ” í•¨ìˆ˜
function setCalendarData(year, month){        
let calHtml = "";
// ì´ë²ˆ ë‹¬ì˜ ì²«ì§¸ ë‚  ê°ì²´ ë°˜í™˜
const setDate = new Date(year, month - 1, 1);
//ì´ë²ˆ ë‹¬ì˜ ì²«ì§¸ ë‚ ì„ êµ¬í•©ë‹ˆë‹¤.
const firstDay = setDate.getDate();

//ì´ë²ˆ ë‹¬ì˜ ì²˜ìŒ ìš”ì¼ì„ êµ¬í•©ë‹ˆë‹¤ / (0-6)
const firstDayName = setDate.getDay();

//ì´ë²ˆ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ì˜ ë‚ ì§œ(ìˆ«ì)ë¥¼ êµ¬í•©ë‹ˆë‹¤.
const lastDay = new Date(year, month, 0).getDate();
//ì§€ë‚œ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ì˜ ë‚ ì§œ(ìˆ«ì)ë¥¼ êµ¬í•©ë‹ˆë‹¤.
const prevLastDay = new Date(year, month-1, 0).getDate();

let startDayCount = 1;
let lastDayCount = 1;
for (let i = 0; i < 6; i++) {
    for (let j = 0; j < 7; j++) {
        if (i == 0 && j < firstDayName) {
        if (j == 0) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFB3BB; visibility: hidden' class='calendar__day horizontalGutter'><span>${(prevLastDay - (firstDayName - 1) + j)}</span><span></span></div>`;
        } else if (j == 6) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFB3BB; visibility: hidden' class='calendar__day'><span>${(prevLastDay - (firstDayName - 1) + j)}</span><span></span></div>`;
        } else {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFB3BB; visibility: hidden' class='calendar__day horizontalGutter'><span>${(prevLastDay - (firstDayName - 1) + j)}</span><span></span></div>`;
        }
        }
        else if (i == 0 && j == firstDayName) {
        if (j == 0) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFE0BB;' class='calendar__day horizontalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        } else if (j == 6) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFE0BB;' class='calendar__day'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        } else {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFE0BB;' class='calendar__day horizontalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        }
        }
        else if (i == 0 && j > firstDayName) {
        if (j == 0) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFFFBB' class='calendar__day horizontalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        } else if (j == 6) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFFFBB' class='calendar__day'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        } else {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color:#FFFFBB' class='calendar__day horizontalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        }
        }
        else if (i > 0 && startDayCount <= lastDay) {
        if (j == 0) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color: var(--sunday);'class='calendar__day horizontalGutter verticalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        } else if (j == 6) {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color: var(--saturday);'class='calendar__day verticalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        } else {
        // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
        calHtml +=
        `<div style='background-color: var(--base);'class='calendar__day horizontalGutter verticalGutter'><span>${startDayCount}</span><span id='${year}${month}${setFixDayCount(startDayCount++)}'></span></div>`;
        }
        }
        }
    }
    calendarTitle.innerHTML = months[(+month)%13];
    document
    .querySelector(".calendar")
    .insertAdjacentHTML("beforeend", calHtml);
};


    const setFixDayCount = number => {
    let fixNum = "";
    if (number < 10) {
    fixNum = "0" + number;
    } else {
    fixNum = number;
    }
    return fixNum;
    };



    // TODO 
    // 1. ë‹¤ìŒ ë‹¬ í‘œì‹œ
    //  - after ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë‹¤ìŒ ë‹¬ (ë…„ë„ë¥¼ ì‹ ê²½ì“°ì§€ ë§ê³  êµ¬í•´ë³´ì)
    //  - ì €ë²ˆ ë‹¬ ë³´ì—¬ì£¼ëŠ” ê±¸ ì§€ìš°ëŠ” í•¨ìˆ˜
    // 2. ì§€ë‚œ ë‹¬ í‘œì‹œ 
    // 3. ë…„ë„ê°€ ë°”ë€” ë•Œ ì—°ë„ë¥¼ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜ + ë…„ë„ê°€ ë°”ë€” ë•Œ í•¨ìˆ˜ ìœ„ì— ì´ë¦„ë„ 
    // 4. ë‚ ì§œ ì„ íƒìë¡œ ì„ íƒ (ì™„ë£Œ)
    // 5. ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
    // 6. ë¦¬í™í† ë§ ë²”ìˆ˜ì“° í•¨ìˆ˜ êµ¬ì„± ì°¸ê³  
    // 7. ì¼ì£¼ì¼ ë‹¨ìœ„ ë³´ì—¬ì£¼ê¸°
    let thisMonth = today.getMonth()+1;
    let thisYear = today.getFullYear();
    let plus = 1;
    let minus = 1;

    function selectMonth(thisMonth, thisYear){
    if (thisMonth < 10) {
    setCalendarData(thisYear, "0" + thisMonth);
    } else {
    setCalendarData(thisYear, "" + thisMonth);
    }
    }



    let afterMonth = document.querySelector('.after');
    afterMonth.addEventListener('click', () => {
    thisMonth += plus;
    document.querySelector(".calendar").innerHTML = ""
    thisYear = (thisMonth === 13) ? thisYear + 1 : thisYear;
    thisMonth = (thisMonth === 13) ? 1 : thisMonth;
    selectMonth(thisMonth, thisYear);
    })

    let previousMonth = document.querySelector('.previous');
    previousMonth.addEventListener('click', () => {
    thisMonth -= minus;
    document.querySelector(".calendar").innerHTML = ""
    thisYear = (thisMonth === 0) ? thisYear - 1 : thisYear;
    thisMonth = (thisMonth === 0) ? 12 : thisMonth;
    selectMonth(thisMonth, thisYear);
    })


    window.addEventListener('DOMContentLoaded', selectMonth(thisMonth, thisYear))

    const todayId = (thisMonth < 10) ? `${thisYear}${'0' + thisMonth}${today.getDate()}`: `${thisYear}${thisMonth}${today.getDate()}`;
    const todaySelector = document.getElementById(`${todayId}`);
    const todayContainer = todaySelector.parentNode;
    todayContainer.style.background = "skyblue";
    // style ì—ì„œ outline ì„ ì¶”ê°€ë§Œ í• êº¼ì•¼


    // Ajax ì½”ë“œ
    const onClickResult = async (id) => {
    const url = "/result_ajax/";

    const { data } = await axios.post(url, {
        id,
        });
    modify(data.id, data.result);
        if (data.result == true){
            changeCalendar(data.title, todayId)
        }
    };

    const modify = (id, result) => {
        const result_word = document.querySelector(`.result-${id} .result_word`);

        if (result === false) {
        result_word.value = "ì„±ê³µì‹œ í´ë¦­";
        result_word.classList.remove("success");
        result_word.classList.add("fail");
        } else {
        result_word.value = "ì±Œë¦°ì§€ ì„±ê³µ";
        result_word.classList.remove("fail");
        result_word.classList.add("success");
        }
    };

    const changeCalendar = (title, date) => {
        const challengeContent = title + 'ğŸ¤”';
        const newTag = document.createElement('p');
        const thisday = document.getElementById(`${date}`);
        newTag.classList.add('done');
        newTag.textContent = challengeContent;
        thisday.append(newTag)
    }

    // date, title 
    let enrollmentDateList = JSON.parse({{challenge_success|safe}});
    let challengeTitleList = {{challenge_success_title|safe}}
    for(let enrollmentDate in enrollmentDateList){
        let {enrollment, date} = enrollmentDateList[enrollmentDate]["fields"]
        enrollment = challengeTitleList[enrollment]
        console.log(enrollment)
        date = date.replace('-', '')
        date = date.replace('-', '')
        changeCalendar(enrollment, date)
    }
    console.log(enrollmentDateList)
    console.log({{challenge_success_title|safe}});
    console.log(challengeTitleList[1])
    </script>
{% endblock %}